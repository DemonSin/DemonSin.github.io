---
title: "pwnable.kr leg"
Categories:
    - Pwn
tag:
    - Pwn
    - Writeup
    - Pwnable.kr
---

> Daddy told me I should study arm.  
> But I prefer to study my leg!  
>
> Download : <http://pwnable.kr/bin/leg.c>  
> Download : <http://pwnable.kr/bin/leg.asm>  
>
> ssh leg@pwnable.kr -p2222 (pw:guest)  

这题考查ARM相关的一些东西,要求是让我们输入三个函数的返回值的和。我们知道ARM里面是通过r0来传递的返回值。

<!-- more -->

## key1

```asm
    0x00008cdc <+8>:    mov r3, pc
    0x00008ce0 <+12>:   mov r0, r3
```

很明显，就是返回当前pc的值，那么pc里面存的是什么呢?

pc (Program Countor, 程序计数器)用于存放下一条指令所在单元的地址，功能与Inter格式的ip相像。

这里还需要注意一个地方ARM处理器的流水线机制。ARM7中采用的是三级流水线，其把指令的处理分为了3个阶段。

> 取指(Fetch):   从存储器装载一条指令  
> 译码(Decode):  识别将要被执行的指令  
> 执行(Execute): 处理指令并将结果写回寄存器  

在第一条指令执行到'执行'时，第二条指令正在'译码'，pc指向的第三条指令则在执行'取指'操作。

所以我们这的答案就很明显了，当前处于ARM状态 (指令长度是4字节)，所以每条指令为4个字节长,以当前指令为第一条指令，那么pc指向第三条指令，所以r0中即r3中的值为0x8cdc+0x8。

## key2

这里是考的状态的转换。

```asm
    0x00008cfc <+12>:   add r6, pc, #1
    0x00008d00 <+16>:   bx  r6
```

执行上面两段代码后，程序就会由ARM状态切换成Thumb状态。

因为ARM状态和Thumb状态的指令均是偶数字节对齐的 (ARM是4字节， Thumb是2字节)，指令地址的最后一位一定是0，所以我们可以拿最后一为来判断是那种状态。简来讲就是bx为跳转指令，单当跳转的目标地址的最后一位为1时，就是跳转到Thumb指令执行即切换成Thumb工作状态，反之则跳转到ARM指令执行即切换成ARM工作状态。

```asm
    0x00008d04 <+20>:   mov     r3, pc
    0x00008d06 <+22>:   adds    r3, #4
    ...
    0x00008d10 <+32>:   mov     r0, r3
```

再看上面的代码我们就知道这个函数的返回值为0x8d04+0x4+0x4。为什么加两个0x4?流水线和0x8d06处的代码啊。

## key3

最后这个是考的lr寄存器。

```asm
    0x00008d28 <+8>:    mov r3, lr
    0x00008d2c <+12>:   mov r0, r3
```

lr (Link Register, 连接寄存器) 也叫子程序连接寄存器 (Subroutine Link Register)。在执行带链接跳转指令BL时会将R15 (程序计数器pc) 的备份到R14 (连接寄存器LR) 中去。

```asm
    0x00008d7c <+64>:   bl  0x8d20 <key3>
    0x00008d80 <+68>:   mov r3, r0
```

所以这个函数的返回结果为0x8d80。

## Exploit

所以向程序输入108400 (0x8cdc+0x8 + 0x8d04+0x4+0x4 + 0x8d80 = 0x1A770 = 108400)

flag: My daddy has a lot of ARMv5te muscle!

## 参考资料

+ Umiade. [ARM寄存器结构小记](https://blog.csdn.net/qq_19550513/article/details/62044295)
+ Umiade. [ARM状态结构小记](https://blog.csdn.net/qq_19550513/article/details/62038580)
+ v4ever. [大脸猫讲逆向之ARM汇编中PC寄存器详解](https://bbs.ichunqiu.com/thread-40493-1-1.html?from=bkyl)
+ crifan. [为何ARM7中PC=PC+8](https://www.crifan.com/files/doc/docbook/uboot_starts_analysis/release/htmls/why_arm7_pc_8.html)