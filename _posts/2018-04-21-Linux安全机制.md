---
layout: post
title: "Linux安全机制"
date: 2018-04-21 
description: "Linux"
tag: Linux
---

## 0x00 checksec

在运行程序之前，我们可以使用`checksec`命令查看程序开启了那些保护。

## 0x01 canary: 金丝雀

canary与GS的原理是一样。他们都是在函数执行之前保存一个`Security cookie`，也就是在堆栈中的返回地址之前。等函数准备返回时检查这个`cookie`，如果和原来的值不一样就停止运行。攻击者攻击堆栈，造成堆栈溢出覆盖返回地址，那么返回地址前面的这个`cookie`也一定会被覆盖，这栈保护检测不能通过，也就无法按原来的意愿执行shellcode。

这个canary名字来自矿工的金丝雀。金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；而当瓦斯含量超过一定限度时，金丝雀却早已毒发身亡。以前采矿设备相对简陋，矿工们就用金丝雀作为“瓦斯检测指标”，好及时发现危险撤离。

```shell
$ gcc -fno-stack-protector test.c  //canary全部关闭
$ gcc -fstack-protector test.c   //对含有字符串的数组启用canary
$ gcc -fstack-protector-all test.c //为所有函数都使用canary
```

## 0x02 NX: 不可执行内存

NX (No-eXecute 不可执行) 与windows下的DEP (Data Execution Prevention 数据执行保护) 一个意思。其原理是将数据所在的内存页标识为不可执行，当程序成功溢出转入shellcode时，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。

```shell
$ gcc -z execstack test.c   //关闭NX
$ gcc -z noexecstack test.c   //开启NX，NX是默认开启的，所以这个参数其实可以不加
```

## 0x02 ASLR: 地址空间布局随机化

ASLR属于操作系统的功能，我们可以通过`/proc/sys/kernel/randomize_va_space`来查看和修改这一设置，注意，设置时切换到管理员权限。

```shell
# cat /proc/sys/kernel/randomize_va_space
2   启用：默认的
# echo 0 > /proc/sys/kernel/randomize_va_space
# cat /proc/sys/kernel/randomize_va_space
0   禁用
```

使用`cat`命令查看randomize_va_space的值，其 __0__ __1__ __2__ 的含义如下

+ 0: 禁用
+ 1: 除堆以外随机化
+ 2: 全部随机化(默认)

## 0x03 PIE

PIE(position-independent executables 位置独立的可执行区域)

启用PIE `-pie`
关闭PIE `-no-pie`

## 0x04 参考资料

+ 王清. 0day安全：软件漏洞分析技术(第二版). 北京:电子工业出版社，2011
+ R_1v3r. [linux安全机制学习](https://blog.csdn.net/qq_20307987/article/details/51307820)
+ Yun. [checksec及其包含的保护机制](http://yunnigu.dropsec.xyz/2016/10/08/checksec%E5%8F%8A%E5%85%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/)
+ 岁月别催. [WINDOWS和LINUX的内存防护机制](https://blog.csdn.net/x_nirvana/article/details/61420056)
+ 爱甲健二. 周自恒译. 有趣的二进制 软件安全与逆向分析. 人民邮电出版社